<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AetherOS</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-2: #1c1c1c;
            --surface-3: #252525;
            --border: rgba(255,255,255,0.06);
            --border-hover: rgba(255,255,255,0.12);
            --text: #fff;
            --text-2: rgba(255,255,255,0.7);
            --text-3: rgba(255,255,255,0.4);
            --radius: 16px;
            --radius-sm: 10px;
            --radius-lg: 20px;
            --shadow: 0 8px 32px rgba(0,0,0,0.4);
            --glass: rgba(255,255,255,0.03);
            --glass-border: rgba(255,255,255,0.08);
            --transition: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, sans-serif;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.05); } 50% { box-shadow: 0 0 40px rgba(255,255,255,0.15); } }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .fade-in { animation: fadeIn 0.4s var(--transition); }
        .slide-up { animation: slideUp 0.4s var(--transition); }
        .scale-in { animation: scaleIn 0.3s var(--transition); }
        
        /* ===== TITLEBAR ===== */
        .titlebar {
            height: 44px;
            background: linear-gradient(180deg, rgba(30,30,30,0.9) 0%, rgba(15,15,15,0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            -webkit-app-region: drag;
        }
        
        .titlebar-brand { display: flex; align-items: center; gap: 14px; }
        .logo { font-size: 14px; font-weight: 600; letter-spacing: 1px; }
        .version {
            font-size: 10px;
            color: var(--text-3);
            padding: 3px 8px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
        }
        
        .titlebar-controls { display: flex; gap: 10px; -webkit-app-region: no-drag; }
        .win-btn {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s var(--transition);
            background: var(--text-3);
            position: relative;
            overflow: hidden;
        }
        .win-btn:hover { background: var(--text-2); transform: scale(1.15); }
        .win-btn.close:hover { background: #ff5f57; }
        
        /* ===== MAIN LAYOUT ===== */
        .app { display: flex; height: calc(100vh - 44px); }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 72px;
            background: linear-gradient(180deg, var(--surface) 0%, rgba(18,18,18,1) 100%);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 8px;
        }
        
        /* Glass Icon Button */
        .icon-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .icon-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.25s;
            border-radius: inherit;
        }
        
        .icon-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            box-shadow: inset 0 0 0 1px transparent;
            transition: box-shadow 0.25s;
        }
        
        .icon-btn:hover {
            background: rgba(255,255,255,0.04);
            border-color: var(--glass-border);
            transform: translateY(-3px) scale(1.02);
        }
        
        .icon-btn:hover::before { opacity: 1; }
        .icon-btn:hover::after { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); }
        
        .icon-btn:active { transform: translateY(-1px) scale(0.98); }
        
        .icon-btn.active {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.15);
            box-shadow: 0 4px 20px rgba(255,255,255,0.05);
        }
        
        .icon-btn svg {
            width: 22px;
            height: 22px;
            stroke: var(--text-3);
            stroke-width: 1.5;
            fill: none;
            transition: all 0.25s var(--transition);
        }
        
        .icon-btn:hover svg { stroke: var(--text); transform: scale(1.1); }
        .icon-btn.active svg { stroke: var(--text); }
        
        .icon-btn .status {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--text-3);
            transition: all 0.3s;
        }
        .icon-btn .status.on {
            background: #fff;
            box-shadow: 0 0 10px #fff, 0 0 20px rgba(255,255,255,0.5);
        }
        
        .sidebar-divider {
            width: 28px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
            margin: 10px 0;
        }
        
        .sidebar-spacer { flex: 1; }
        
        /* Launcher Button */
        .launcher-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--glass);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--transition);
            position: relative;
        }
        
        .launcher-btn::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .launcher-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 0 30px rgba(255,255,255,0.1);
        }
        
        .launcher-btn:hover::before { opacity: 1; }
        
        .launcher-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-2);
            stroke-width: 2;
            fill: none;
            transition: stroke 0.3s;
        }
        
        .launcher-btn:hover svg { stroke: var(--text); }
        
        /* ===== WORKSPACE ===== */
        .workspace {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--bg);
        }
        
        /* Animated dot grid canvas container */
        #dotGrid {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0.4;
        }
        
        /* Ambient glow */
        .workspace::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(255,255,255,0.015) 0%, transparent 60%);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        /* ===== PANELS ===== */
        .panel {
            position: absolute;
            min-width: 340px;
            min-height: 220px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,0.02) inset;
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .panel:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow), 0 0 60px rgba(0,0,0,0.3);
        }
        
        .panel.focused {
            border-color: rgba(255,255,255,0.18);
            box-shadow: 0 16px 64px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05) inset;
            z-index: 100;
        }
        
        .panel.maximized {
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            border-radius: 0;
        }
        
        .panel.minimized { display: none; }
        
        .panel-header {
            height: 48px;
            background: linear-gradient(180deg, var(--surface-2) 0%, var(--surface) 100%);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 18px;
            cursor: move;
            flex-shrink: 0;
        }
        
        .panel-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-2);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.3px;
        }
        
        .panel-title svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-3);
            stroke-width: 1.5;
            fill: none;
        }
        
        .panel-controls { display: flex; gap: 10px; }
        
        .panel-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .panel-btn svg {
            width: 14px;
            height: 14px;
            stroke: var(--text-3);
            stroke-width: 2;
            fill: none;
            transition: stroke 0.2s;
        }
        
        .panel-btn:hover {
            background: var(--glass);
            transform: scale(1.1);
        }
        .panel-btn:hover svg { stroke: var(--text-2); }
        .panel-btn.close:hover { background: rgba(255,100,100,0.15); }
        .panel-btn.close:hover svg { stroke: #ff6b6b; }
        
        .panel-content {
            flex: 1;
            overflow: auto;
            padding: 18px;
            display: flex;
            flex-direction: column;
        }
        
        /* Resize handles */
        .resize { position: absolute; }
        .resize-n { top: -5px; left: 20px; right: 20px; height: 10px; cursor: n-resize; }
        .resize-s { bottom: -5px; left: 20px; right: 20px; height: 10px; cursor: s-resize; }
        .resize-e { right: -5px; top: 20px; bottom: 20px; width: 10px; cursor: e-resize; }
        .resize-w { left: -5px; top: 20px; bottom: 20px; width: 10px; cursor: w-resize; }
        .resize-ne { top: -5px; right: -5px; width: 20px; height: 20px; cursor: ne-resize; }
        .resize-nw { top: -5px; left: -5px; width: 20px; height: 20px; cursor: nw-resize; }
        .resize-se { bottom: -5px; right: -5px; width: 20px; height: 20px; cursor: se-resize; }
        .resize-sw { bottom: -5px; left: -5px; width: 20px; height: 20px; cursor: sw-resize; }
        
        /* ===== WIDGETS SIDEBAR ===== */
        .widgets {
            width: 220px;
            background: linear-gradient(270deg, rgba(18,18,18,1) 0%, var(--surface) 100%);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: all 0.4s var(--transition);
        }
        
        .widgets.collapsed { width: 0; border: none; overflow: hidden; }
        
        .widget {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        
        .widget:hover { background: rgba(255,255,255,0.01); }
        
        .widget-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .widget-value {
            font-size: 28px;
            font-weight: 300;
            color: var(--text);
            letter-spacing: -1px;
        }
        
        .widget-sub {
            font-size: 11px;
            color: var(--text-3);
            margin-top: 6px;
        }
        
        .widget-bar {
            height: 4px;
            background: var(--surface-3);
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .widget-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--text-3), var(--text));
            border-radius: 4px;
            transition: width 0.4s var(--transition);
        }
        
        .widget-graph {
            height: 40px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            margin-top: 12px;
        }
        
        .widget-graph-bar {
            flex: 1;
            background: var(--text-3);
            border-radius: 3px 3px 0 0;
            min-height: 3px;
            transition: height 0.4s var(--transition);
        }
        
        .widget-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-2);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .widget-btn:hover {
            background: rgba(255,255,255,0.06);
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }
        
        .widget-btn:active { transform: translateY(0); }
        
        /* Toggle Button */
        .sidebar-toggle {
            position: absolute;
            right: 220px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 60px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-right: none;
            border-radius: 10px 0 0 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s var(--transition);
            z-index: 50;
        }
        
        .sidebar-toggle:hover { background: var(--surface-3); width: 24px; }
        .sidebar-toggle.collapsed { right: 0; }
        
        .sidebar-toggle svg {
            width: 12px;
            height: 12px;
            stroke: var(--text-3);
            stroke-width: 2;
            fill: none;
            transition: all 0.4s var(--transition);
        }
        
        .sidebar-toggle.collapsed svg { transform: rotate(180deg); }
        
        /* ===== MIN DOCK ===== */
        .min-dock {
            position: absolute;
            bottom: 0;
            left: 72px;
            right: 220px;
            height: 50px;
            background: rgba(15,15,15,0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 10px;
            transition: right 0.4s var(--transition);
        }
        
        .min-dock:empty { display: none; }
        .min-dock.wide { right: 0; }
        
        .min-item {
            padding: 10px 18px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--text-2);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.25s var(--transition);
        }
        
        .min-item:hover {
            border-color: var(--border-hover);
            background: var(--surface-3);
            transform: translateY(-3px);
        }
        
        .min-item .close { opacity: 0.4; cursor: pointer; transition: all 0.2s; }
        .min-item .close:hover { opacity: 1; color: #ff6b6b; }
        
        /* ===== LAUNCHER ===== */
        .launcher-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .launcher-overlay.active { display: flex; }
        
        .launcher {
            width: 680px;
            max-height: 80vh;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: 0 32px 100px rgba(0,0,0,0.6);
            overflow: hidden;
            animation: scaleIn 0.25s var(--transition);
        }
        
        .launcher-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .launcher-search {
            width: 100%;
            padding: 14px 20px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-family: inherit;
            font-size: 15px;
            outline: none;
            transition: all 0.25s var(--transition);
        }
        
        .launcher-search:focus {
            border-color: var(--border-hover);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.03);
        }
        
        .launcher-search::placeholder { color: var(--text-3); }
        
        .launcher-tabs { display: flex; gap: 6px; }
        
        .launcher-tab {
            padding: 10px 18px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text-3);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s var(--transition);
        }
        
        .launcher-tab:hover { color: var(--text-2); background: var(--glass); }
        
        .launcher-tab.active {
            background: rgba(255,255,255,0.06);
            border-color: var(--border);
            color: var(--text);
        }
        
        .launcher-content { padding: 20px; max-height: 55vh; overflow-y: auto; }
        
        .launcher-section { margin-bottom: 28px; }
        
        .launcher-section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
            padding-left: 6px;
        }
        
        .launcher-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        
        .launcher-item {
            padding: 20px 14px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .launcher-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .launcher-item:hover {
            background: var(--surface-3);
            border-color: var(--border-hover);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        
        .launcher-item:hover::before { opacity: 1; }
        
        .launcher-item-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s var(--transition);
        }
        
        .launcher-item:hover .launcher-item-icon {
            transform: scale(1.1);
            border-color: var(--border-hover);
        }
        
        .launcher-item-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-2);
            stroke-width: 1.5;
            fill: none;
        }
        
        .launcher-item-name { font-size: 12px; color: var(--text-2); margin-bottom: 6px; font-weight: 500; }
        .launcher-item-status { font-size: 10px; color: var(--text-3); }
        .launcher-item-status.on { color: var(--text); }
        
        /* Plugin Upload */
        .plugin-upload {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s var(--transition);
            margin-bottom: 20px;
        }
        
        .plugin-upload:hover {
            border-color: var(--border-hover);
            background: var(--glass);
            transform: scale(1.01);
        }
        
        .plugin-upload.dragover {
            border-color: var(--text-3);
            background: rgba(255,255,255,0.02);
        }
        
        .plugin-upload-icon { font-size: 28px; margin-bottom: 12px; opacity: 0.4; }
        .plugin-upload-text { font-size: 13px; color: var(--text-3); }
        
        /* Plugin Item Styles */
        .plugin-item {
            position: relative;
        }
        
        .plugin-uninstall {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text-3);
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .plugin-item:hover .plugin-uninstall {
            opacity: 1;
        }
        
        .plugin-uninstall:hover {
            background: #ff5f57;
            border-color: #ff5f57;
            color: white;
        }
        
        .plugin-available {
            border: 1px dashed var(--border);
        }
        
        .launcher-item-desc {
            font-size: 10px;
            color: var(--text-3);
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }
        
        .launcher-item-status.download {
            color: #4ade80;
        }
        
        /* Update Modal Enhancements */
        .update-release-name {
            font-size: 14px;
            color: var(--text-2);
            margin: 12px 0;
            font-weight: 500;
        }
        
        .update-notes {
            font-size: 12px;
            color: var(--text-3);
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-top: 12px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        
        /* ===== COMMON INPUTS ===== */
        .input {
            width: 100%;
            padding: 12px 16px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            outline: none;
            transition: all 0.25s var(--transition);
        }
        
        .input:focus {
            border-color: var(--border-hover);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.03);
        }
        
        .input::placeholder { color: var(--text-3); }
        
        .btn {
            padding: 12px 20px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-2);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s var(--transition);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--border-hover);
            color: var(--text);
            transform: translateY(-2px);
        }
        
        .btn:active { transform: translateY(0); }
        
        .btn.primary {
            background: var(--text);
            border-color: var(--text);
            color: var(--bg);
        }
        
        .btn.primary:hover {
            background: var(--text-2);
            border-color: var(--text-2);
            box-shadow: 0 8px 24px rgba(255,255,255,0.15);
        }
        
        .select {
            padding: 12px 16px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.25s;
        }
        
        .select:focus { border-color: var(--border-hover); }
        .select option { background: var(--surface); }
        
        .row { display: flex; gap: 12px; align-items: center; }
        .col { display: flex; flex-direction: column; gap: 8px; }
        .flex-1 { flex: 1; }
        .mb { margin-bottom: 14px; }
        .label { font-size: 11px; color: var(--text-3); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }
        
        /* ===== TOOL STYLES ===== */
        
        /* Chat */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 14px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        .chat-msg {
            max-width: 85%;
            animation: slideUp 0.3s var(--transition);
        }
        
        .chat-msg.user {
            align-self: flex-end;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius) var(--radius) 6px var(--radius);
            padding: 14px 18px;
            font-size: 13px;
            color: var(--text-2);
        }
        
        .chat-msg.ai {
            align-self: flex-start;
            font-size: 13px;
            line-height: 1.7;
            color: var(--text);
        }
        
        .chat-msg.ai p { margin-bottom: 12px; }
        .chat-msg.ai code { background: var(--surface-2); padding: 3px 8px; border-radius: 6px; font-size: 12px; }
        .chat-msg.ai pre { background: var(--surface-2); padding: 16px; border-radius: var(--radius-sm); margin: 14px 0; overflow-x: auto; border: 1px solid var(--border); }
        .chat-msg.ai pre code { background: none; padding: 0; }
        .chat-msg.ai ul, .chat-msg.ai ol { margin: 10px 0 10px 24px; }
        .chat-msg.ai li { margin-bottom: 6px; }
        .chat-msg.ai strong { color: var(--text); font-weight: 600; }
        
        /* Terminal */
        .term-output {
            flex: 1;
            overflow-y: auto;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 12px;
            line-height: 1.7;
            margin-bottom: 12px;
        }
        
        .term-line { margin-bottom: 6px; animation: fadeIn 0.15s; }
        .term-line.cmd { color: var(--text); }
        .term-line.cmd::before { content: '‚ùØ '; color: var(--text-3); }
        .term-line.out { color: var(--text-2); padding-left: 18px; }
        .term-line.err { color: #ff6b6b; padding-left: 18px; }
        
        .term-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            border: 1px solid var(--border);
        }
        
        .term-prompt {
            color: var(--text-3);
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 12px;
        }
        
        .term-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 12px;
            outline: none;
        }
        
        /* File Manager */
        .fm-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s var(--transition);
            border: 1px solid transparent;
        }
        
        .fm-item:hover {
            background: var(--glass);
            border-color: var(--border);
            transform: translateX(4px);
        }
        
        .fm-item svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-3);
            stroke-width: 1.5;
            fill: none;
        }
        
        .fm-name { flex: 1; font-size: 13px; color: var(--text-2); }
        .fm-size { font-size: 11px; color: var(--text-3); }
        
        /* Notes */
        .notes-canvas {
            flex: 1;
            position: relative;
            overflow: auto;
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        .note-card {
            position: absolute;
            min-width: 200px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: move;
            transition: all 0.25s var(--transition);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .note-card:hover {
            border-color: var(--border-hover);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        
        .note-card.selected {
            border-color: var(--text-3);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        
        .note-header {
            padding: 12px 16px;
            background: var(--surface-2);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .note-title {
            background: transparent;
            border: none;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            flex: 1;
            outline: none;
        }
        
        .note-delete { color: var(--text-3); cursor: pointer; transition: color 0.2s; }
        .note-delete:hover { color: #ff6b6b; }
        
        .note-body textarea {
            width: 100%;
            min-height: 100px;
            background: transparent;
            border: none;
            color: var(--text-2);
            font-family: inherit;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            padding: 16px;
        }
        
        /* System Monitor */
        .sysmon-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        
        .sysmon-card {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            transition: all 0.25s var(--transition);
        }
        
        .sysmon-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }
        
        .sysmon-label { font-size: 10px; font-weight: 600; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; }
        .sysmon-val { font-size: 24px; font-weight: 300; margin: 8px 0; }
        .sysmon-sub { font-size: 11px; color: var(--text-3); }
        .sysmon-bar { height: 4px; background: var(--surface-3); border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .sysmon-bar-fill { height: 100%; background: var(--text-2); border-radius: 4px; transition: width 0.4s var(--transition); }
        
        .process-list { flex: 1; overflow-y: auto; }
        .process-item { display: flex; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 12px; transition: background 0.2s; }
        .process-item:hover { background: var(--glass); margin: 0 -16px; padding: 10px 16px; }
        .process-name { flex: 1; color: var(--text-2); overflow: hidden; text-overflow: ellipsis; }
        .process-val { width: 55px; text-align: right; color: var(--text-3); }
        
        /* Image/Video Gen */
        .gen-preview {
            flex: 1;
            min-height: 220px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            padding: 18px;
            margin-bottom: 14px;
            overflow: auto;
        }
        
        .gen-preview img, .gen-preview video {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s var(--transition);
            border: 2px solid transparent;
        }
        
        .gen-preview img:hover, .gen-preview video:hover {
            border-color: var(--border-hover);
            transform: scale(1.02);
        }
        
        .gen-preview img.selected {
            border-color: var(--text);
            box-shadow: 0 0 30px rgba(255,255,255,0.15);
        }
        
        .gen-placeholder { color: var(--text-3); font-size: 14px; }
        .gen-loading { animation: pulse 1.5s infinite; }
        
        /* TTS/STT */
        .tts-textarea { flex: 1; min-height: 140px; resize: none; margin-bottom: 14px; }
        .audio-player { margin-top: 14px; }
        .audio-player audio { width: 100%; height: 44px; border-radius: var(--radius-sm); }
        
        .stt-dropzone {
            flex: 1;
            min-height: 160px;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s var(--transition);
            margin-bottom: 14px;
        }
        
        .stt-dropzone:hover {
            border-color: var(--border-hover);
            background: var(--glass);
            transform: scale(1.01);
        }
        
        .stt-dropzone.dragover { border-color: var(--text-3); background: rgba(255,255,255,0.02); }
        
        .stt-dropzone svg {
            width: 36px;
            height: 36px;
            stroke: var(--text-3);
            stroke-width: 1.5;
            fill: none;
            margin-bottom: 14px;
        }
        
        .stt-dropzone-text { font-size: 13px; color: var(--text-3); }
        
        .stt-result {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            font-size: 14px;
            line-height: 1.7;
            flex: 1;
            overflow-y: auto;
        }
        
        /* Code Editor */
        .editor-content {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            tab-size: 4;
            color: var(--text);
            transition: border-color 0.25s;
        }
        
        .editor-content:focus { border-color: var(--border-hover); }
        
        /* Spreadsheet */
        .sheet-container { flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); }
        
        .sheet-table { border-collapse: collapse; width: 100%; }
        .sheet-table th {
            background: var(--surface-2);
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-3);
            border: 1px solid var(--border);
            position: sticky;
            top: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sheet-table td { padding: 10px 14px; border: 1px solid var(--border); font-size: 13px; }
        
        .sheet-table td input {
            background: transparent;
            border: none;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            width: 100%;
            outline: none;
        }
        
        .sheet-table tr:hover td { background: var(--glass); }
        
        /* Status bar */
        .statusbar {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 220px;
            height: 32px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 18px;
            font-size: 11px;
            color: var(--text-3);
            transition: width 0.4s var(--transition);
        }
        
        .statusbar.wide { width: 140px; }
        
        /* ===== UPDATE MODAL ===== */
        .update-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .update-overlay.active { display: flex; }
        
        .update-modal {
            width: 500px;
            max-height: 70vh;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: 0 32px 100px rgba(0,0,0,0.6);
            overflow: hidden;
            animation: scaleIn 0.25s var(--transition);
        }
        
        .update-header {
            padding: 18px 20px;
            background: var(--surface-2);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .update-title { font-size: 14px; font-weight: 500; }
        
        .update-content {
            padding: 24px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .update-checking { color: var(--text-3); text-align: center; padding: 30px; }
        
        .update-version {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .update-version-label { font-size: 12px; color: var(--text-3); }
        .update-version-number { font-size: 20px; font-weight: 300; }
        .update-version-new { color: #4ade80; }
        
        .update-files {
            margin-top: 16px;
        }
        
        .update-files-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .update-file {
            padding: 8px 12px;
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            font-size: 12px;
            color: var(--text-2);
            font-family: 'SF Mono', Consolas, monospace;
        }
        
        .update-progress {
            margin-top: 20px;
        }
        
        .update-progress-bar {
            height: 6px;
            background: var(--surface-3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .update-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--text-3), var(--text));
            border-radius: 6px;
            transition: width 0.3s var(--transition);
        }
        
        .update-progress-text {
            font-size: 12px;
            color: var(--text-3);
            text-align: center;
        }
        
        .update-actions {
            padding: 16px 20px;
            background: var(--surface-2);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .update-actions:empty { display: none; }
        
        .update-success {
            text-align: center;
            padding: 20px;
        }
        
        .update-success-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .update-success-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .update-success-sub {
            font-size: 13px;
            color: var(--text-3);
        }
        
        /* ===== VIRAL STUDIO ===== */
        .viral-studio {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .viral-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: var(--surface-2);
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        
        .viral-tab {
            flex: 1;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-3);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .viral-tab:hover { color: var(--text-2); }
        .viral-tab.active {
            background: var(--surface-3);
            color: var(--text);
        }
        
        .viral-panel {
            flex: 1;
            overflow-y: auto;
        }
        
        .viral-footage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 4px;
        }
        
        .viral-footage-item {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .viral-footage-item:hover {
            border-color: var(--text-3);
            transform: scale(1.02);
        }
        
        .viral-footage-item.selected {
            border-color: var(--text);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        
        .viral-footage-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .viral-footage-item .duration {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            color: white;
        }
        
        .viral-selected-clips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 60px;
            background: var(--surface-2);
            border: 1px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 10px;
        }
        
        .viral-selected-clip {
            width: 80px;
            height: 45px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .viral-selected-clip img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .viral-selected-clip .remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: rgba(255,0,0,0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }
        
        .viral-summary {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 13px;
        }
        
        .viral-summary strong {
            color: var(--text-3);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="titlebar">
        <div class="titlebar-brand">
            <span class="logo">AETHEROS</span>
            <span class="version">v2.0</span>
        </div>
        <div class="titlebar-controls">
            <div class="win-btn" onclick="aether.minimizeWindow()"></div>
            <div class="win-btn" onclick="aether.maximizeWindow()"></div>
            <div class="win-btn close" onclick="saveAndClose()"></div>
        </div>
    </div>
    
    <div class="app">
        <div class="sidebar" id="sidebar"></div>
        <div class="workspace" id="workspace">
            <canvas id="dotGrid"></canvas>
        </div>
        <div class="sidebar-toggle" id="sidebarToggle" onclick="toggleWidgets()">
            <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
        </div>
        <div class="widgets" id="widgets">
            <div class="widget">
                <div class="widget-label">Uptime</div>
                <div class="widget-value" id="wUptime">00:00:00</div>
            </div>
            <div class="widget">
                <div class="widget-label">CPU</div>
                <div class="widget-value" id="wCpu">--%</div>
                <div class="widget-bar"><div class="widget-bar-fill" id="wCpuBar"></div></div>
                <div class="widget-graph" id="wCpuGraph"></div>
            </div>
            <div class="widget">
                <div class="widget-label">Memory</div>
                <div class="widget-value" id="wRam">--%</div>
                <div class="widget-sub" id="wRamSub">-- / --</div>
                <div class="widget-bar"><div class="widget-bar-fill" id="wRamBar"></div></div>
            </div>
            <div class="widget" id="wGpuWidget" style="display:none">
                <div class="widget-label">GPU</div>
                <div class="widget-value" id="wGpu">--%</div>
                <div class="widget-sub" id="wGpuSub">--</div>
            </div>
            <div class="widget">
                <div class="widget-label">Network</div>
                <div class="row" style="font-size:13px;gap:20px;margin-top:6px;">
                    <span>‚Üë <span id="wNetUp">0</span></span>
                    <span>‚Üì <span id="wNetDown">0</span></span>
                </div>
            </div>
            <div class="widget">
                <div class="widget-label">Tools Online</div>
                <div class="widget-value" id="wTools">0</div>
            </div>
            <div class="widget">
                <button class="widget-btn" onclick="openLauncher()">Open Launcher</button>
                <button class="widget-btn" onclick="resetLayout()">Reset Layout</button>
                <button class="widget-btn" onclick="checkUpdates()">Check Updates</button>
            </div>
        </div>
        <div class="min-dock" id="minDock"></div>
        <div class="statusbar" id="statusbar">
            <span id="statusText">Ready</span>
            <span id="statusTime"></span>
        </div>
    </div>
    
    <!-- Update Modal -->
    <div class="update-overlay" id="updateOverlay">
        <div class="update-modal">
            <div class="update-header">
                <span class="update-title">Software Update</span>
                <button class="panel-btn close" onclick="closeUpdateModal()">
                    <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="update-content" id="updateContent">
                <div class="update-checking">Checking for updates...</div>
            </div>
            <div class="update-actions" id="updateActions"></div>
        </div>
    </div>
    
    <div class="launcher-overlay" id="launcherOverlay" onclick="if(event.target===this)closeLauncher()">
        <div class="launcher">
            <div class="launcher-header">
                <input class="launcher-search" id="launcherSearch" placeholder="Search..." autocomplete="off">
                <div class="launcher-tabs">
                    <button class="launcher-tab active" data-tab="tools" onclick="switchTab('tools')">Tools</button>
                    <button class="launcher-tab" data-tab="apps" onclick="switchTab('apps')">PC Apps</button>
                    <button class="launcher-tab" data-tab="plugins" onclick="switchTab('plugins')">Plugins</button>
                </div>
            </div>
            <div class="launcher-content" id="launcherContent"></div>
        </div>
    </div>
    
    <input type="file" id="pluginFile" accept=".zip" style="display:none">

    <script>
    const ICONS = {
        chat: '<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
        image: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',
        video: '<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3z"/></svg>',
        speaker: '<svg viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>',
        mic: '<svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>',
        folder: '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
        note: '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',
        code: '<svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
        table: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>',
        terminal: '<svg viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>',
        monitor: '<svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
        grid: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
        minimize: '<svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg>',
        maximize: '<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>',
        close: '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
        upload: '<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
        app: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M8 12h8M12 8v8"/></svg>',
        film: '<svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>'
    };
    
    const TOOLS = {
        ollama_chat: { icon: 'chat', name: 'Chat', cat: 'ai', port: 5003 },
        image_gen: { icon: 'image', name: 'Image Gen', cat: 'ai', port: 5004 },
        video_gen: { icon: 'video', name: 'Video Gen', cat: 'ai', port: 5012 },
        tts_engine: { icon: 'speaker', name: 'Text to Speech', cat: 'ai', port: 5005 },
        stt_engine: { icon: 'mic', name: 'Speech to Text', cat: 'ai', port: 5006 },
        file_manager: { icon: 'folder', name: 'Files', cat: 'prod', port: 5007 },
        notes: { icon: 'note', name: 'Notes', cat: 'prod', port: 5008 },
        code_editor: { icon: 'code', name: 'Editor', cat: 'prod', port: 5011 },
        spreadsheet_engine: { icon: 'table', name: 'Sheets', cat: 'prod', port: 5002 },
        terminal: { icon: 'terminal', name: 'Terminal', cat: 'sys', port: 5010 },
        system_monitor: { icon: 'monitor', name: 'Monitor', cat: 'sys', port: 5009 }
    };
    
    // Dynamic plugin registry (loaded from orchestrator)
    let PLUGINS = {};
    let AVAILABLE_PLUGINS = [];
    
    const DEFAULT_LAYOUT = { ollama_chat: { x: 90, y: 30, w: 500, h: 440 }, terminal: { x: 90, y: 490, w: 500, h: 200 } };
    
    const S = { panels: {}, tools: {}, pcApps: [], activePanel: null, zIndex: 10, startTime: Date.now(), drag: null, resize: null, noteDrag: null, widgetsVisible: true, launcherTab: 'tools', cpuHistory: [], session: { chatHistory: '', terminalOutput: '', editorFile: null, editorContent: '', spreadsheet: { headers: ['A','B','C','D','E'], rows: Array(10).fill(null).map(()=>Array(5).fill('')) }, currentPath: '', termCwd: '~' } };
    
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    
    function playSound(type) {
        try {
            if (!audioCtx) audioCtx = new AudioCtx();
            const t = audioCtx.currentTime;
            
            if (type === 'click') {
                // Soft pop
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, t);
                osc.frequency.exponentialRampToValueAtTime(440, t + 0.05);
                gain.gain.setValueAtTime(0.08, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t);
                osc.stop(t + 0.08);
            } else if (type === 'open') {
                // Rising chime
                [523, 659, 784].forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, t + i * 0.05);
                    gain.gain.linearRampToValueAtTime(0.06, t + i * 0.05 + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.05 + 0.15);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(t + i * 0.05);
                    osc.stop(t + i * 0.05 + 0.15);
                });
            } else if (type === 'close') {
                // Falling tone
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(660, t);
                osc.frequency.exponentialRampToValueAtTime(330, t + 0.12);
                gain.gain.setValueAtTime(0.07, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t);
                osc.stop(t + 0.12);
            } else if (type === 'success') {
                // Happy chord
                [523, 659, 784, 1047].forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.05, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(t);
                    osc.stop(t + 0.3);
                });
            } else if (type === 'error') {
                // Low buzz
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.setValueAtTime(140, t + 0.1);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t);
                osc.stop(t + 0.2);
            }
        } catch {}
    }
    
    const formatTime = ms => { const s = Math.floor(ms/1000)%60, m = Math.floor(ms/60000)%60, h = Math.floor(ms/3600000); return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; };
    const formatBytes = b => b < 1024 ? b+' B' : b < 1048576 ? (b/1024).toFixed(1)+' KB' : b < 1073741824 ? (b/1048576).toFixed(1)+' MB' : (b/1073741824).toFixed(1)+' GB';
    const formatSpeed = b => b < 1024 ? b.toFixed(0)+' B/s' : b < 1048576 ? (b/1024).toFixed(1)+' KB/s' : (b/1048576).toFixed(1)+' MB/s';
    const setStatus = msg => document.getElementById('statusText').textContent = msg;
    
    function parseMarkdown(t) { if (!t) return ''; let h = t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); h = h.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>'); h = h.replace(/`([^`]+)`/g, '<code>$1</code>'); h = h.replace(/^### (.+)$/gm, '<strong>$1</strong><br>'); h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>'); h = h.replace(/\*(.+?)\*/g, '<em>$1</em>'); h = h.replace(/^\* (.+)$/gm, '‚Ä¢ $1<br>'); h = h.replace(/^- (.+)$/gm, '‚Ä¢ $1<br>'); h = h.replace(/\n\n/g, '</p><p>'); return '<p>' + h.replace(/\n/g, '<br>') + '</p>'; }
    
    function renderSidebar() { const sb = document.getElementById('sidebar'); sb.innerHTML = ''; const cats = { ai: [], prod: [], sys: [] }; Object.entries(TOOLS).forEach(([id, t]) => cats[t.cat].push({ id, ...t })); Object.entries(cats).forEach(([cat, tools]) => { tools.forEach(t => { const btn = document.createElement('div'); btn.className = 'icon-btn' + (S.panels[t.id] && !S.panels[t.id].min ? ' active' : ''); btn.innerHTML = ICONS[t.icon] + `<span class="status ${S.tools[t.id]?.running ? 'on' : ''}"></span>`; btn.title = t.name; btn.onclick = () => { playSound('click'); togglePanel(t.id); }; sb.appendChild(btn); }); if (cat !== 'sys') { const div = document.createElement('div'); div.className = 'sidebar-divider'; sb.appendChild(div); } }); const spacer = document.createElement('div'); spacer.className = 'sidebar-spacer'; sb.appendChild(spacer); const launcher = document.createElement('div'); launcher.className = 'launcher-btn'; launcher.innerHTML = ICONS.grid; launcher.onclick = () => { playSound('open'); openLauncher(); }; sb.appendChild(launcher); }
    
    function toggleWidgets() { S.widgetsVisible = !S.widgetsVisible; document.getElementById('widgets').classList.toggle('collapsed', !S.widgetsVisible); document.getElementById('sidebarToggle').classList.toggle('collapsed', !S.widgetsVisible); document.getElementById('minDock').classList.toggle('wide', !S.widgetsVisible); document.getElementById('statusbar').classList.toggle('wide', !S.widgetsVisible); playSound('click'); }
    
    function createPanel(id) { const tool = TOOLS[id]; if (!tool) return; const layout = loadLayout()[id] || DEFAULT_LAYOUT[id] || { x: 100 + Math.random()*150, y: 50 + Math.random()*80, w: 460, h: 400 }; const panel = document.createElement('div'); panel.className = 'panel scale-in'; panel.id = `panel-${id}`; panel.style.cssText = `left:${layout.x}px;top:${layout.y}px;width:${layout.w}px;height:${layout.h}px;z-index:${++S.zIndex}`; panel.innerHTML = `<div class="panel-header"><span class="panel-title">${ICONS[tool.icon]}${tool.name}</span><div class="panel-controls"><button class="panel-btn" onclick="minimizePanel('${id}')">${ICONS.minimize}</button><button class="panel-btn" onclick="maximizePanel('${id}')">${ICONS.maximize}</button><button class="panel-btn close" onclick="closePanel('${id}')">${ICONS.close}</button></div></div><div class="panel-content" id="content-${id}"></div><div class="resize resize-n"></div><div class="resize resize-s"></div><div class="resize resize-e"></div><div class="resize resize-w"></div><div class="resize resize-ne"></div><div class="resize resize-nw"></div><div class="resize resize-se"></div><div class="resize resize-sw"></div>`; panel.querySelector('.panel-header').onmousedown = e => startDrag(e, id); panel.querySelectorAll('.resize').forEach(h => h.onmousedown = e => startResize(e, id, h.className.split(' ')[1].replace('resize-', ''))); panel.onmousedown = () => focusPanel(id); document.getElementById('workspace').appendChild(panel); S.panels[id] = { el: panel, min: false, max: false }; renderContent(id); initTool(id); focusPanel(id); renderSidebar(); saveLayout(); playSound('open'); }
    
    function renderContent(id) { const c = document.getElementById(`content-${id}`); if (!c) return; const T = { ollama_chat: `<div class="chat-messages" id="chatMsgs"></div><div class="row"><input class="input flex-1" id="chatIn" placeholder="Type a message..."><button class="btn primary" onclick="sendChat()">Send</button></div>`, image_gen: `<div class="gen-preview" id="imgPreview"><span class="gen-placeholder">Enter a prompt to generate</span></div><div class="row mb"><input class="input flex-1" id="imgPrompt" placeholder="Describe your image..."><button class="btn primary" onclick="genImage()">Generate</button></div><div class="row"><div class="col flex-1"><span class="label">Aspect</span><select class="select" id="imgRatio" style="width:100%"><option value="1:1">1:1</option><option value="16:9">16:9</option><option value="9:16">9:16</option></select></div><div class="col"><span class="label">Batch</span><select class="select" id="imgBatch"><option>1</option><option>2</option><option>4</option></select></div><div class="col"><span class="label">Steps</span><input class="input" type="number" id="imgSteps" value="4" style="width:60px"></div><button class="btn" onclick="unloadImageModel()" title="Free GPU memory">üóëÔ∏è</button></div>`, video_gen: `<div class="gen-preview" id="vidPreview"><span class="gen-placeholder">Generate an image first, then animate it</span></div><div class="row mb"><div class="col flex-1"><span class="label">Motion Preset</span><select class="select" id="vidPreset" style="width:100%"><option value="zoom_in">Zoom In</option><option value="zoom_out">Zoom Out</option><option value="pan_left">Pan Left</option><option value="pan_right">Pan Right</option><option value="pan_up">Pan Up</option><option value="pan_down">Pan Down</option><option value="zoom_pan_tl">Zoom to Top-Left</option><option value="zoom_pan_tr">Zoom to Top-Right</option><option value="zoom_pan_bl">Zoom to Bottom-Left</option><option value="zoom_pan_br">Zoom to Bottom-Right</option><option value="dramatic_zoom">Dramatic Zoom</option><option value="slow_drift">Slow Drift</option></select></div></div><div class="row mb"><div class="col flex-1"><span class="label">Duration (s)</span><input class="input" type="number" id="vidDuration" value="3" min="1" max="10" style="width:70px"></div><div class="col flex-1"><span class="label">FPS</span><input class="input" type="number" id="vidFps" value="24" min="12" max="60" style="width:70px"></div><button class="btn primary" onclick="genVideo()" id="vidGenBtn">Animate</button></div><div class="row mb"><input type="file" id="vidImageFile" accept="image/*" style="display:none"><button class="btn" onclick="document.getElementById('vidImageFile').click()">Load Image</button><span style="flex:1;font-size:11px;color:var(--text-3);text-align:right" id="vidImageName">No image loaded</span></div><div style="font-size:11px;color:var(--text-3);margin-top:8px">Creates smooth camera motion from any image. No GPU required.</div>`, tts_engine: `<textarea class="input tts-textarea" id="ttsText" placeholder="Enter text to speak..."></textarea><div class="row mb"><div class="col flex-1"><span class="label">Model</span><select class="select" id="ttsModel" style="width:100%"><option value="tts_models/en/ljspeech/tacotron2-DDC">LJSpeech Tacotron2</option><option value="tts_models/en/ljspeech/glow-tts">LJSpeech GlowTTS</option><option value="tts_models/en/vctk/vits">VCTK VITS</option></select></div><button class="btn primary" onclick="synth()">Speak</button></div><div id="ttsSpeakerRow" class="row mb" style="display:none"><div class="col flex-1"><span class="label">Speaker</span><select class="select" id="ttsSpeaker" style="width:100%"></select></div></div><div class="audio-player" id="ttsAudio"></div>`, stt_engine: `<div class="stt-dropzone" id="sttDrop">${ICONS.upload}<span class="stt-dropzone-text">Drop audio file or click to upload</span><input type="file" id="sttFile" accept="audio/*" style="display:none"></div><div class="stt-result" id="sttResult">Transcription will appear here...</div>`, file_manager: `<div class="row mb"><button class="btn" onclick="fmUp()">‚Üë</button><input class="input flex-1" id="fmPath"><button class="btn" onclick="fmGo()">Go</button></div><div style="flex:1;overflow:auto" id="fmList"></div>`, notes: `<div class="row mb"><button class="btn" onclick="addNote()">+ Add Note</button><button class="btn" onclick="loadNotes()">Refresh</button></div><div class="notes-canvas" id="notesCanvas"></div>`, terminal: `<div class="term-output" id="termOut"></div><div class="term-input-row"><span class="term-prompt" id="termPrompt">~$</span><input class="term-input" id="termIn" placeholder="Enter command..."></div>`, system_monitor: `<div class="sysmon-grid" id="sysGrid"></div><div style="font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Processes</div><div class="process-list" id="procList"></div>`, code_editor: `<div class="row mb"><button class="btn" onclick="edOpen()">Open</button><button class="btn" onclick="edSave()">Save</button><button class="btn" onclick="edNew()">New</button><span style="flex:1;font-size:12px;color:var(--text-3);text-align:right" id="edName">Untitled</span></div><textarea class="editor-content" id="edContent" placeholder="// Code here...">${S.session.editorContent||''}</textarea>`, spreadsheet_engine: `<div class="row mb"><button class="btn" onclick="sheetLoad()">Load CSV</button><button class="btn" onclick="sheetNew()">New</button><button class="btn" onclick="sheetAddRow()">+ Row</button><button class="btn" onclick="sheetAddCol()">+ Col</button><input type="file" id="sheetFile" accept=".csv" style="display:none"></div><div class="sheet-container" id="sheetTable"></div>`, viral_studio: `
<div class="viral-studio">
    <div class="viral-tabs">
        <button class="viral-tab active" onclick="vsTab('script')">1. Script</button>
        <button class="viral-tab" onclick="vsTab('footage')">2. Footage</button>
        <button class="viral-tab" onclick="vsTab('voice')">3. Voice</button>
        <button class="viral-tab" onclick="vsTab('render')">4. Render</button>
    </div>
    
    <div class="viral-panel" id="vsScript">
        <div class="col mb">
            <span class="label">Channel Niche</span>
            <select class="select" id="vsNiche" onchange="vsLoadNiche()" style="width:100%">
                <option value="motivation">üí™ Motivational</option>
                <option value="scary">üëª Scary Stories</option>
                <option value="facts">üß† Interesting Facts</option>
                <option value="storytime">üìñ Storytime</option>
                <option value="finance">üí∞ Finance</option>
                <option value="custom">‚öôÔ∏è Custom</option>
            </select>
        </div>
        <div class="col mb">
            <span class="label">Video Topic</span>
            <input class="input" id="vsTopic" placeholder="e.g., Why successful people wake up at 5AM">
        </div>
        <button class="btn primary" onclick="vsGenScript()" style="width:100%;margin-bottom:14px">Generate Script with AI</button>
        <div class="col mb">
            <span class="label">Script (edit as needed)</span>
            <textarea class="input" id="vsScriptText" style="min-height:150px;resize:vertical" placeholder="Your video script will appear here..."></textarea>
        </div>
        <div style="font-size:11px;color:var(--text-3)">Word count: <span id="vsWordCount">0</span> | Est. duration: <span id="vsDuration">0</span>s</div>
    </div>
    
    <div class="viral-panel" id="vsFootage" style="display:none">
        <div class="row mb">
            <input class="input flex-1" id="vsFootageQuery" placeholder="Search for footage...">
            <button class="btn primary" onclick="vsSearchFootage()">Search</button>
        </div>
        <div class="viral-footage-grid" id="vsFootageGrid">
            <div style="color:var(--text-3);text-align:center;padding:40px">Search for stock footage above</div>
        </div>
        <div class="col mb" style="margin-top:14px">
            <span class="label">Selected Clips (<span id="vsClipCount">0</span>)</span>
            <div class="viral-selected-clips" id="vsSelectedClips"></div>
        </div>
    </div>
    
    <div class="viral-panel" id="vsVoice" style="display:none">
        <div class="col mb">
            <span class="label">Select Voice</span>
            <select class="select" id="vsVoiceSelect" style="width:100%">
                <option value="en-US-JennyNeural">Jenny (Female, Friendly)</option>
                <option value="en-US-GuyNeural">Guy (Male, Newscast)</option>
                <option value="en-US-AriaNeural">Aria (Female, Expressive)</option>
                <option value="en-US-DavisNeural">Davis (Male, Professional)</option>
                <option value="en-US-ChristopherNeural">Christopher (Male, Deep)</option>
                <option value="en-US-EricNeural">Eric (Male, Casual)</option>
                <option value="en-US-MichelleNeural">Michelle (Female, Warm)</option>
                <option value="en-GB-SoniaNeural">Sonia (Female, British)</option>
                <option value="en-GB-RyanNeural">Ryan (Male, British)</option>
            </select>
        </div>
        <button class="btn" onclick="vsPreviewVoice()" style="margin-bottom:14px">Preview Voice</button>
        <div class="audio-player" id="vsVoicePreview"></div>
        <div class="col mb" style="margin-top:14px">
            <span class="label">Caption Style</span>
            <select class="select" id="vsCaptionStyle" style="width:100%">
                <option value="bold">Bold (White + Stroke)</option>
                <option value="yellow">Yellow Pop</option>
                <option value="modern">Modern (Dark BG)</option>
                <option value="minimal">Minimal</option>
            </select>
        </div>
    </div>
    
    <div class="viral-panel" id="vsRender" style="display:none">
        <div class="viral-summary">
            <div><strong>Script:</strong> <span id="vsSummaryWords">0</span> words</div>
            <div><strong>Clips:</strong> <span id="vsSummaryClips">0</span> selected</div>
            <div><strong>Voice:</strong> <span id="vsSummaryVoice">Jenny</span></div>
            <div><strong>Style:</strong> <span id="vsSummaryStyle">Bold</span></div>
        </div>
        <button class="btn primary" onclick="vsRenderVideo()" style="width:100%;margin:14px 0;padding:16px;font-size:15px">üé¨ Generate Video</button>
        <div class="gen-preview" id="vsVideoPreview" style="min-height:200px">
            <span class="gen-placeholder">Your video will appear here</span>
        </div>
    </div>
    
    <div class="viral-api-keys" style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
        <details>
            <summary style="font-size:11px;color:var(--text-3);cursor:pointer">API Keys (for stock footage)</summary>
            <div class="row" style="margin-top:10px;gap:8px">
                <input class="input flex-1" id="vsPixabayKey" placeholder="Pixabay API Key">
                <input class="input flex-1" id="vsPexelsKey" placeholder="Pexels API Key">
                <button class="btn" onclick="vsSaveApiKeys()">Save</button>
            </div>
            <div style="font-size:10px;color:var(--text-3);margin-top:6px">Get free keys: <a href="https://pixabay.com/api/docs/" target="_blank" style="color:var(--text-2)">Pixabay</a> | <a href="https://www.pexels.com/api/" target="_blank" style="color:var(--text-2)">Pexels</a></div>
        </details>
    </div>
</div>
` }; c.innerHTML = T[id] || '<div style="color:var(--text-3)">No UI available</div>'; }
    
    function initTool(id) { switch(id) { case 'ollama_chat': document.getElementById('chatIn').onkeydown = e => { if(e.key==='Enter') sendChat(); }; restoreChat(); break; case 'image_gen': document.getElementById('imgPrompt').onkeydown = e => { if(e.key==='Enter') genImage(); }; break; case 'video_gen': initVideoGen(); break; case 'terminal': initTerminal(); document.getElementById('termIn').onkeydown = e => { if(e.key==='Enter') execCmd(); }; break; case 'file_manager': initFM(); break; case 'notes': loadNotes(); break; case 'system_monitor': updateSysmon(); break; case 'tts_engine': initTTS(); break; case 'stt_engine': initSTT(); break; case 'spreadsheet_engine': renderSheet(); document.getElementById('sheetFile').onchange = loadCSV; break; case 'code_editor': if (S.session.editorFile) document.getElementById('edName').textContent = S.session.editorFile; break; } }
    
    function togglePanel(id) { S.panels[id] ? (S.panels[id].min ? restorePanel(id) : closePanel(id)) : createPanel(id); }
    function focusPanel(id) { Object.values(S.panels).forEach(p => p.el?.classList.remove('focused')); if (S.panels[id]?.el) { S.panels[id].el.classList.add('focused'); S.panels[id].el.style.zIndex = ++S.zIndex; } S.activePanel = id; }
    function closePanel(id) { S.panels[id]?.el?.remove(); delete S.panels[id]; renderMinDock(); renderSidebar(); saveLayout(); playSound('close'); }
    function minimizePanel(id) { if (S.panels[id]) { S.panels[id].min = true; S.panels[id].el.classList.add('minimized'); renderMinDock(); renderSidebar(); playSound('click'); } }
    function restorePanel(id) { if (S.panels[id]) { S.panels[id].min = false; S.panels[id].el.classList.remove('minimized'); focusPanel(id); renderMinDock(); renderSidebar(); playSound('open'); } }
    function maximizePanel(id) { if (S.panels[id]) { S.panels[id].max = !S.panels[id].max; S.panels[id].el.classList.toggle('maximized'); playSound('click'); } }
    
    function renderMinDock() { const dock = document.getElementById('minDock'); dock.innerHTML = ''; Object.entries(S.panels).forEach(([id, p]) => { if (p.min) { const t = TOOLS[id]; const item = document.createElement('div'); item.className = 'min-item'; item.innerHTML = `${t.name} <span class="close" onclick="event.stopPropagation();closePanel('${id}')">√ó</span>`; item.onclick = () => restorePanel(id); dock.appendChild(item); } }); }
    
    function startDrag(e, id) { if (e.target.closest('.panel-btn')) return; const p = S.panels[id]; if (!p || p.max) return; focusPanel(id); S.drag = { id, sx: e.clientX, sy: e.clientY, sl: p.el.offsetLeft, st: p.el.offsetTop }; e.preventDefault(); }
    function startResize(e, id, dir) { const p = S.panels[id]; if (!p || p.max) return; focusPanel(id); S.resize = { id, dir, sx: e.clientX, sy: e.clientY, sl: p.el.offsetLeft, st: p.el.offsetTop, sw: p.el.offsetWidth, sh: p.el.offsetHeight }; e.preventDefault(); e.stopPropagation(); }
    
    document.onmousemove = e => { if (S.drag) { const p = S.panels[S.drag.id]; if (p) { p.el.style.left = (S.drag.sl + e.clientX - S.drag.sx) + 'px'; p.el.style.top = (S.drag.st + e.clientY - S.drag.sy) + 'px'; } } if (S.resize) { const { id, dir, sx, sy, sl, st, sw, sh } = S.resize; const p = S.panels[id]; if (p) { const dx = e.clientX - sx, dy = e.clientY - sy; if (dir.includes('e')) p.el.style.width = Math.max(340, sw + dx) + 'px'; if (dir.includes('w')) { p.el.style.width = Math.max(340, sw - dx) + 'px'; p.el.style.left = (sl + dx) + 'px'; } if (dir.includes('s')) p.el.style.height = Math.max(220, sh + dy) + 'px'; if (dir.includes('n')) { p.el.style.height = Math.max(220, sh - dy) + 'px'; p.el.style.top = (st + dy) + 'px'; } } } if (S.noteDrag) { const { el, ox, oy } = S.noteDrag; const canvas = document.getElementById('notesCanvas'); const r = canvas.getBoundingClientRect(); el.style.left = Math.max(0, e.clientX - r.left - ox + canvas.scrollLeft) + 'px'; el.style.top = Math.max(0, e.clientY - r.top - oy + canvas.scrollTop) + 'px'; } };
    
    document.onmouseup = () => { if (S.drag || S.resize) saveLayout(); S.drag = null; S.resize = null; if (S.noteDrag) { const { id, el } = S.noteDrag; fetch(`http://127.0.0.1:5008/boards/${S.currentBoard}/cards/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ x: parseInt(el.style.left), y: parseInt(el.style.top) }) }); el.classList.remove('selected'); S.noteDrag = null; } };
    
    function saveLayout() { const l = {}; Object.entries(S.panels).forEach(([id, p]) => { if (p.el && !p.min) l[id] = { x: p.el.offsetLeft, y: p.el.offsetTop, w: p.el.offsetWidth, h: p.el.offsetHeight }; }); localStorage.setItem('aether-layout', JSON.stringify(l)); }
    function loadLayout() { try { return JSON.parse(localStorage.getItem('aether-layout')) || {}; } catch { return {}; } }
    function resetLayout() { localStorage.removeItem('aether-layout'); playSound('click'); location.reload(); }
    
    async function saveSession() { const chatMsgs = document.getElementById('chatMsgs'); if (chatMsgs) S.session.chatHistory = chatMsgs.innerHTML; const edContent = document.getElementById('edContent'); if (edContent) S.session.editorContent = edContent.value; const termOut = document.getElementById('termOut'); if (termOut) S.session.terminalOutput = termOut.innerHTML; S.session.openPanels = Object.keys(S.panels).filter(id => !S.panels[id].min); await aether.saveSession(S.session); }
    async function loadSession() { const data = await aether.loadSession(); if (data) S.session = { ...S.session, ...data }; }
    function restoreChat() { const msgs = document.getElementById('chatMsgs'); if (msgs && S.session.chatHistory) { msgs.innerHTML = S.session.chatHistory; msgs.scrollTop = msgs.scrollHeight; } }
    async function saveAndClose() { await saveSession(); aether.closeWindow(); }
    
    function openLauncher() { 
        document.getElementById('launcherOverlay').classList.add('active'); 
        document.getElementById('launcherSearch').focus(); 
        loadPlugins().then(() => {
            renderLauncher(); 
        });
        loadPcApps(); 
    }
    function closeLauncher() { document.getElementById('launcherOverlay').classList.remove('active'); playSound('close'); }
    function switchTab(tab) { S.launcherTab = tab; document.querySelectorAll('.launcher-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab)); renderLauncher(); }
    async function loadPcApps() { S.pcApps = await aether.getPcApps(); if (S.launcherTab === 'apps') renderLauncher(); }
    
    function renderLauncher(filter = '') { 
        const c = document.getElementById('launcherContent'); 
        const f = filter.toLowerCase(); 
        
        if (S.launcherTab === 'tools') { 
            const cats = { ai: 'AI Tools', prod: 'Productivity', sys: 'System' }; 
            let html = ''; 
            Object.entries(cats).forEach(([cat, title]) => { 
                const tools = Object.entries(TOOLS).filter(([id, t]) => t.cat === cat && (!f || t.name.toLowerCase().includes(f))); 
                if (tools.length) { 
                    html += `<div class="launcher-section"><div class="launcher-section-title">${title}</div><div class="launcher-grid">`; 
                    tools.forEach(([id, t]) => { 
                        const on = S.tools[id]?.running; 
                        html += `<div class="launcher-item" onclick="launchTool('${id}')"><div class="launcher-item-icon">${ICONS[t.icon]}</div><div class="launcher-item-name">${t.name}</div><div class="launcher-item-status ${on?'on':''}">${on?'Online':'Offline'}</div></div>`; 
                    }); 
                    html += '</div></div>'; 
                } 
            }); 
            c.innerHTML = html; 
        } else if (S.launcherTab === 'apps') { 
            const filtered = S.pcApps.filter(a => !f || a.name.toLowerCase().includes(f)); 
            c.innerHTML = `<div class="launcher-section"><div class="launcher-section-title">Installed Applications</div><div class="launcher-grid">${filtered.map(a => `<div class="launcher-item" onclick="launchPcApp('${a.path.replace(/\\/g,'\\\\')}', ${JSON.stringify(a.args||[])})"><div class="launcher-item-icon">${a.icon || ICONS.app}</div><div class="launcher-item-name">${a.name}</div></div>`).join('')}</div></div>`; 
        } else if (S.launcherTab === 'plugins') { 
            renderPluginsTab(f);
        }
    }
    
    async function loadPlugins() {
        try {
            const installed = await aether.getInstalledPlugins();
            PLUGINS = {};
            installed.forEach(p => {
                PLUGINS[p.id] = p;
            });
            
            // Also try to get available plugins
            try {
                AVAILABLE_PLUGINS = await aether.getAvailablePlugins();
            } catch (e) {
                console.log('Could not load available plugins:', e);
            }
        } catch (e) {
            console.error('Failed to load plugins:', e);
        }
    }
    
    function renderPluginsTab(filter = '') {
        const c = document.getElementById('launcherContent');
        const f = filter.toLowerCase();
        
        let html = '';
        
        // Installed plugins section
        const installedPlugins = Object.values(PLUGINS).filter(p => !f || p.displayName?.toLowerCase().includes(f) || p.name?.toLowerCase().includes(f));
        
        if (installedPlugins.length > 0) {
            html += `<div class="launcher-section"><div class="launcher-section-title">Installed Plugins</div><div class="launcher-grid">`;
            installedPlugins.forEach(p => {
                const on = S.tools[p.id]?.running || p.running;
                html += `
                    <div class="launcher-item plugin-item" onclick="launchPlugin('${p.id}')">
                        <div class="launcher-item-icon">${p.icon || 'üîå'}</div>
                        <div class="launcher-item-name">${p.displayName || p.name}</div>
                        <div class="launcher-item-status ${on?'on':''}">${on?'Online':'Offline'}</div>
                        <button class="plugin-uninstall" onclick="event.stopPropagation();uninstallPlugin('${p.id}')" title="Uninstall">√ó</button>
                    </div>`;
            });
            html += '</div></div>';
        }
        
        // Available plugins section
        const available = AVAILABLE_PLUGINS.filter(p => {
            const isInstalled = PLUGINS[p.id] || PLUGINS[p.name];
            const matchesFilter = !f || p.displayName?.toLowerCase().includes(f) || p.name?.toLowerCase().includes(f) || p.description?.toLowerCase().includes(f);
            return !isInstalled && matchesFilter;
        });
        
        if (available.length > 0) {
            html += `<div class="launcher-section"><div class="launcher-section-title">Available to Download</div><div class="launcher-grid">`;
            available.forEach(p => {
                html += `
                    <div class="launcher-item plugin-available" onclick="downloadPlugin('${p.id}', '${p.displayName || p.name}', '${p.downloadUrl || ''}')">
                        <div class="launcher-item-icon">${p.icon || 'üì¶'}</div>
                        <div class="launcher-item-name">${p.displayName || p.name}</div>
                        <div class="launcher-item-desc">${p.description || ''}</div>
                        <div class="launcher-item-status download">‚Üì Download</div>
                    </div>`;
            });
            html += '</div></div>';
        }
        
        // Upload section
        html += `
            <div class="launcher-section">
                <div class="launcher-section-title">Install from File</div>
                <div class="plugin-upload" id="pluginUpload">
                    <div class="plugin-upload-icon">${ICONS.upload}</div>
                    <div class="plugin-upload-text">Drop plugin ZIP or click to upload</div>
                </div>
            </div>`;
        
        c.innerHTML = html;
        
        // Set up upload handlers
        const upload = document.getElementById('pluginUpload');
        const file = document.getElementById('pluginFile');
        if (upload && file) {
            upload.onclick = () => file.click();
            upload.ondragover = e => { e.preventDefault(); upload.classList.add('dragover'); };
            upload.ondragleave = () => upload.classList.remove('dragover');
            upload.ondrop = e => { 
                e.preventDefault(); 
                upload.classList.remove('dragover'); 
                if (e.dataTransfer.files.length) {
                    installPluginFromFile(e.dataTransfer.files[0]);
                }
            };
            file.onchange = () => {
                if (file.files.length) {
                    installPluginFromFile(file.files[0]);
                }
            };
        }
    }
    
    async function launchPlugin(pluginId) {
        closeLauncher();
        playSound('click');
        setStatus(`Launching ${pluginId}...`);
        
        // Check if there's a UI for this plugin
        if (PLUGINS[pluginId]) {
            const plugin = PLUGINS[pluginId];
            
            // If plugin is not running, start it
            if (!S.tools[pluginId]?.running) {
                try {
                    await aether.startPlugin(pluginId);
                    await refreshStatus();
                } catch (e) {
                    setStatus(`Failed to start ${pluginId}`);
                    playSound('error');
                    return;
                }
            }
            
            // Create a panel for the plugin if it has a UI definition
            createPluginPanel(pluginId, plugin);
        }
    }
    
    function createPluginPanel(pluginId, plugin) {
        // Check if panel already exists
        if (S.panels[pluginId]) {
            focusPanel(pluginId);
            return;
        }
        
        const layout = loadLayout()[pluginId] || { x: 100 + Math.random()*150, y: 50 + Math.random()*80, w: 500, h: 450 };
        const panel = document.createElement('div');
        panel.className = 'panel scale-in';
        panel.id = `panel-${pluginId}`;
        panel.style.cssText = `left:${layout.x}px;top:${layout.y}px;width:${layout.w}px;height:${layout.h}px;z-index:${++S.zIndex}`;
        
        const port = plugin.port || S.tools[pluginId]?.port || 5100;
        
        panel.innerHTML = `
            <div class="panel-header">
                <span class="panel-title">${plugin.icon || 'üîå'} ${plugin.displayName || plugin.name}</span>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="minimizePanel('${pluginId}')">${ICONS.minimize}</button>
                    <button class="panel-btn" onclick="maximizePanel('${pluginId}')">${ICONS.maximize}</button>
                    <button class="panel-btn close" onclick="closePanel('${pluginId}')">${ICONS.close}</button>
                </div>
            </div>
            <div class="panel-content" id="content-${pluginId}">
                <iframe src="http://127.0.0.1:${port}" style="width:100%;height:100%;border:none;background:#0a0a0a"></iframe>
            </div>
            <div class="resize resize-n"></div><div class="resize resize-s"></div>
            <div class="resize resize-e"></div><div class="resize resize-w"></div>
            <div class="resize resize-ne"></div><div class="resize resize-nw"></div>
            <div class="resize resize-se"></div><div class="resize resize-sw"></div>`;
        
        panel.querySelector('.panel-header').onmousedown = e => startDrag(e, pluginId);
        panel.querySelectorAll('.resize').forEach(h => h.onmousedown = e => startResize(e, pluginId, h.className.split(' ')[1].replace('resize-', '')));
        panel.onmousedown = () => focusPanel(pluginId);
        
        document.getElementById('workspace').appendChild(panel);
        S.panels[pluginId] = { el: panel, min: false, max: false };
        focusPanel(pluginId);
        saveLayout();
        playSound('open');
        setStatus(`${plugin.displayName || plugin.name} opened`);
    }
    
    async function downloadPlugin(pluginId, displayName, downloadUrl) {
        if (!downloadUrl) {
            setStatus('Download URL not available');
            playSound('error');
            return;
        }
        
        playSound('click');
        setStatus(`Downloading ${displayName}...`);
        
        try {
            const result = await aether.downloadPlugin({ 
                id: pluginId, 
                name: pluginId,
                displayName: displayName,
                downloadUrl: downloadUrl 
            });
            
            if (result.success) {
                setStatus(`${displayName} installed!`);
                playSound('success');
                await loadPlugins();
                await refreshStatus();
                renderPluginsTab();
            } else {
                setStatus(`Failed: ${result.error}`);
                playSound('error');
            }
        } catch (e) {
            setStatus(`Error: ${e.message}`);
            playSound('error');
        }
    }
    
    async function uninstallPlugin(pluginId) {
        if (!confirm(`Uninstall ${PLUGINS[pluginId]?.displayName || pluginId}?`)) return;
        
        playSound('click');
        setStatus(`Uninstalling ${pluginId}...`);
        
        try {
            // Close panel if open
            if (S.panels[pluginId]) {
                closePanel(pluginId);
            }
            
            const result = await aether.uninstallPlugin(pluginId);
            if (result.success) {
                setStatus('Plugin uninstalled');
                playSound('success');
                await loadPlugins();
                await refreshStatus();
                renderPluginsTab();
            } else {
                setStatus(`Failed: ${result.error}`);
                playSound('error');
            }
        } catch (e) {
            setStatus(`Error: ${e.message}`);
            playSound('error');
        }
    }
    
    async function installPluginFromFile(file) {
        if (!file.name.endsWith('.zip')) {
            setStatus('Please select a ZIP file');
            playSound('error');
            return;
        }
        
        playSound('click');
        setStatus('Installing plugin...');
        
        try {
            const result = await aether.installPlugin(file.path);
            if (result.success) {
                setStatus(`${result.plugin?.displayName || 'Plugin'} installed!`);
                playSound('success');
                await loadPlugins();
                await refreshStatus();
                renderPluginsTab();
            } else {
                setStatus(`Failed: ${result.error}`);
                playSound('error');
            }
        } catch (e) {
            setStatus(`Error: ${e.message}`);
            playSound('error');
        }
    }
    
    document.getElementById('launcherSearch').oninput = e => renderLauncher(e.target.value);
    document.onkeydown = e => { if (e.key === 'Escape') closeLauncher(); };
    
    function launchTool(id) { closeLauncher(); if (!S.panels[id]) createPanel(id); else focusPanel(id); }
    async function launchPcApp(path, args) { await aether.launchPcApp(path, args); closeLauncher(); playSound('success'); }
    
    async function sendChat() { const input = document.getElementById('chatIn'); const msgs = document.getElementById('chatMsgs'); const text = input.value.trim(); if (!text) return; msgs.innerHTML += `<div class="chat-msg user">${text}</div>`; input.value = ''; setStatus('Thinking...'); playSound('click'); try { const res = await fetch('http://127.0.0.1:5003/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text }) }); const data = await res.json(); msgs.innerHTML += `<div class="chat-msg ai">${parseMarkdown(data.response || data.error)}</div>`; setStatus('Ready'); playSound('success'); } catch(e) { msgs.innerHTML += `<div class="chat-msg ai">Error: ${e.message}</div>`; setStatus('Error'); playSound('error'); } msgs.scrollTop = msgs.scrollHeight; }
    
    async function genImage() { const prompt = document.getElementById('imgPrompt').value.trim(); const preview = document.getElementById('imgPreview'); if (!prompt) return; preview.innerHTML = '<span class="gen-placeholder gen-loading">Generating...</span>'; setStatus('Generating...'); playSound('click'); try { const res = await fetch('http://127.0.0.1:5004/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, aspect_ratio: document.getElementById('imgRatio').value, batch_size: parseInt(document.getElementById('imgBatch').value), steps: parseInt(document.getElementById('imgSteps').value) || 4 }) }); const data = await res.json(); if (data.images?.length) { preview.innerHTML = data.images.map((img, i) => `<img src="data:image/png;base64,${img}" onclick="this.classList.toggle('selected')">`).join(''); setStatus('Generated'); playSound('success'); } else { preview.innerHTML = `<span class="gen-placeholder">${data.error || 'Failed'}</span>`; setStatus('Error'); playSound('error'); } } catch(e) { preview.innerHTML = `<span class="gen-placeholder">Error: ${e.message}</span>`; setStatus('Error'); playSound('error'); } }
    
    async function unloadImageModel() {
        try {
            const res = await fetch('http://127.0.0.1:5004/unload', { method: 'POST' });
            const data = await res.json();
            setStatus(data.message || 'Model unloaded');
            playSound('success');
        } catch(e) {
            setStatus('Failed to unload');
            playSound('error');
        }
    }
    
    // Video Gen with camera motion
    let videoImageData = null;
    
    function initVideoGen() {
        const fileInput = document.getElementById('vidImageFile');
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                videoImageData = ev.target.result;
                document.getElementById('vidImageName').textContent = file.name;
                document.getElementById('vidPreview').innerHTML = `<img src="${videoImageData}" style="max-width:100%;max-height:250px;border-radius:var(--radius-sm)">`;
            };
            reader.readAsDataURL(file);
        };
    }
    
    async function genVideo() {
        const preview = document.getElementById('vidPreview');
        
        // Check if we have an image from either the video panel or from image gen
        let imageToUse = videoImageData;
        
        // If no image loaded, check if there's a selected image in image_gen
        if (!imageToUse) {
            const selectedImg = document.querySelector('#imgPreview img.selected');
            if (selectedImg) {
                imageToUse = selectedImg.src;
            } else {
                // Try first image
                const firstImg = document.querySelector('#imgPreview img');
                if (firstImg) {
                    imageToUse = firstImg.src;
                }
            }
        }
        
        if (!imageToUse) {
            preview.innerHTML = '<span class="gen-placeholder">Load an image first, or generate one in Image Gen</span>';
            playSound('error');
            return;
        }
        
        const preset = document.getElementById('vidPreset').value;
        const duration = parseInt(document.getElementById('vidDuration').value) || 3;
        const fps = parseInt(document.getElementById('vidFps').value) || 24;
        
        preview.innerHTML = '<span class="gen-placeholder gen-loading">Creating video...</span>';
        setStatus('Animating...');
        playSound('click');
        
        try {
            const res = await fetch('http://127.0.0.1:5012/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: imageToUse.split(',')[1] || imageToUse,
                    preset: preset,
                    duration: duration,
                    fps: fps,
                    format: 'gif'
                })
            });
            const data = await res.json();
            if (data.video) {
                preview.innerHTML = `<img src="data:image/gif;base64,${data.video}" style="max-width:100%;border-radius:var(--radius-sm)">`;
                setStatus('Video created');
                playSound('success');
            } else {
                preview.innerHTML = `<span class="gen-placeholder">${data.error || 'Failed'}</span>`;
                setStatus('Error');
                playSound('error');
            }
        } catch(e) {
            preview.innerHTML = `<span class="gen-placeholder">Error: ${e.message}</span>`;
            setStatus('Error');
            playSound('error');
        }
    }
    
    function initTTS() { document.getElementById('ttsModel').onchange = async function() { try { const res = await fetch('http://127.0.0.1:5005/load', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: this.value }) }); const data = await res.json(); const row = document.getElementById('ttsSpeakerRow'); const sel = document.getElementById('ttsSpeaker'); if (data.speakers?.length) { row.style.display = 'flex'; sel.innerHTML = data.speakers.map(s => `<option value="${s}">${s}</option>`).join(''); } else { row.style.display = 'none'; } } catch {} }; }
    async function synth() { const text = document.getElementById('ttsText').value.trim(); if (!text) return; setStatus('Synthesizing...'); playSound('click'); try { const res = await fetch('http://127.0.0.1:5005/synthesize', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text, model: document.getElementById('ttsModel').value, speaker: document.getElementById('ttsSpeaker')?.value }) }); const data = await res.json(); if (data.audio) { document.getElementById('ttsAudio').innerHTML = `<audio controls src="data:audio/wav;base64,${data.audio}"></audio>`; setStatus('Ready'); playSound('success'); } else { setStatus('Error'); playSound('error'); } } catch(e) { setStatus('Error'); playSound('error'); } }
    
    function initSTT() { const drop = document.getElementById('sttDrop'); const file = document.getElementById('sttFile'); drop.onclick = () => file.click(); drop.ondragover = e => { e.preventDefault(); drop.classList.add('dragover'); }; drop.ondragleave = () => drop.classList.remove('dragover'); drop.ondrop = e => { e.preventDefault(); drop.classList.remove('dragover'); if(e.dataTransfer.files.length) transcribe(e.dataTransfer.files[0]); }; file.onchange = () => { if(file.files.length) transcribe(file.files[0]); }; }
    async function transcribe(file) { setStatus('Transcribing...'); document.getElementById('sttResult').textContent = 'Transcribing...'; const fd = new FormData(); fd.append('file', file); try { const res = await fetch('http://127.0.0.1:5006/transcribe', { method: 'POST', body: fd }); const data = await res.json(); document.getElementById('sttResult').textContent = data.text || data.error || 'No result'; setStatus(data.text ? 'Done' : 'Error'); playSound(data.text ? 'success' : 'error'); } catch(e) { document.getElementById('sttResult').textContent = 'Error: ' + e.message; setStatus('Error'); playSound('error'); } }
    
    async function initTerminal() { try { const res = await fetch('http://127.0.0.1:5010/cwd'); const data = await res.json(); S.session.termCwd = data.cwd; updatePrompt(); } catch {} if (S.session.terminalOutput) document.getElementById('termOut').innerHTML = S.session.terminalOutput; }
    function updatePrompt() { const p = S.session.termCwd || '~'; document.getElementById('termPrompt').textContent = (p.length > 20 ? '...' + p.slice(-17) : p) + ' $'; }
    async function execCmd() { const input = document.getElementById('termIn'); const output = document.getElementById('termOut'); const cmd = input.value.trim(); if (!cmd) return; output.innerHTML += `<div class="term-line cmd">${cmd}</div>`; input.value = ''; playSound('click'); try { const res = await fetch('http://127.0.0.1:5010/execute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ command: cmd }) }); const data = await res.json(); if (data.clear) output.innerHTML = ''; else if (data.output) output.innerHTML += `<div class="term-line ${data.success?'out':'err'}">${data.output}</div>`; if (data.cwd) { S.session.termCwd = data.cwd; updatePrompt(); } } catch(e) { output.innerHTML += `<div class="term-line err">Error: ${e.message}</div>`; } output.scrollTop = output.scrollHeight; }
    
    async function initFM() { try { const res = await fetch('http://127.0.0.1:5007/browse'); const data = await res.json(); S.session.currentPath = data.path; document.getElementById('fmPath').value = S.session.currentPath; renderFM(data); } catch {} }
    function renderFM(data) { const list = document.getElementById('fmList'); list.innerHTML = ''; if (data.parent) { const up = document.createElement('div'); up.className = 'fm-item'; up.innerHTML = `${ICONS.folder}<span class="fm-name">..</span>`; up.onclick = () => fmNav(data.parent); list.appendChild(up); } (data.items || []).forEach(f => { const item = document.createElement('div'); item.className = 'fm-item'; item.innerHTML = `${f.is_dir ? ICONS.folder : ICONS.note}<span class="fm-name">${f.name}</span><span class="fm-size">${f.size ? formatBytes(f.size) : ''}</span>`; item.onclick = () => f.is_dir ? fmNav(f.path) : openInEditor(f.path, f.name); list.appendChild(item); }); }
    async function fmNav(path) { S.session.currentPath = path; document.getElementById('fmPath').value = path; const res = await fetch(`http://127.0.0.1:5007/browse?path=${encodeURIComponent(path)}`); renderFM(await res.json()); }
    function fmUp() { const parts = S.session.currentPath.replace(/\\/g,'/').split('/').filter(Boolean); parts.pop(); fmNav(parts.length ? (S.session.currentPath.startsWith('/') ? '/' : '') + parts.join('/') : '/'); }
    function fmGo() { fmNav(document.getElementById('fmPath').value); }
    
    async function loadNotes() { try { const res = await fetch('http://127.0.0.1:5008/boards'); const data = await res.json(); if (data.boards?.length) { S.currentBoard = data.active || data.boards[0].id; const bRes = await fetch(`http://127.0.0.1:5008/boards/${S.currentBoard}`); renderNotes(await bRes.json()); } } catch {} }
    function renderNotes(board) { const canvas = document.getElementById('notesCanvas'); canvas.innerHTML = ''; Object.values(board.cards || {}).forEach(createNoteEl); }
    function createNoteEl(card) { const el = document.createElement('div'); el.className = 'note-card'; el.style.cssText = `left:${card.x}px;top:${card.y}px;width:${card.width||200}px`; el.innerHTML = `<div class="note-header"><input class="note-title" value="${card.title||''}" placeholder="Title" onchange="updateNote('${card.id}','title',this.value)"><span class="note-delete" onclick="deleteNote('${card.id}')">√ó</span></div><div class="note-body"><textarea placeholder="Write something..." onchange="updateNote('${card.id}','content',this.value)">${card.content||''}</textarea></div>`; el.onmousedown = e => { if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; S.noteDrag = { id: card.id, el, ox: e.offsetX, oy: e.offsetY }; el.classList.add('selected'); }; document.getElementById('notesCanvas').appendChild(el); }
    async function addNote() { if (!S.currentBoard) await loadNotes(); const res = await fetch(`http://127.0.0.1:5008/boards/${S.currentBoard}/cards`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ x: 30 + Math.random()*100, y: 30 + Math.random()*60 }) }); const data = await res.json(); if (data.card) createNoteEl(data.card); playSound('click'); }
    function updateNote(id, field, value) { fetch(`http://127.0.0.1:5008/boards/${S.currentBoard}/cards/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ [field]: value }) }); }
    function deleteNote(id) { fetch(`http://127.0.0.1:5008/boards/${S.currentBoard}/cards/${id}`, { method: 'DELETE' }); playSound('click'); loadNotes(); }
    
    async function updateSysmon() { try { const res = await fetch('http://127.0.0.1:5009/stats'); const d = await res.json(); const grid = document.getElementById('sysGrid'); if (grid) { grid.innerHTML = `<div class="sysmon-card"><div class="sysmon-label">CPU</div><div class="sysmon-val">${d.cpu.percent.toFixed(0)}%</div><div class="sysmon-bar"><div class="sysmon-bar-fill" style="width:${d.cpu.percent}%"></div></div></div><div class="sysmon-card"><div class="sysmon-label">Memory</div><div class="sysmon-val">${d.memory.percent.toFixed(0)}%</div><div class="sysmon-sub">${formatBytes(d.memory.used)} / ${formatBytes(d.memory.total)}</div><div class="sysmon-bar"><div class="sysmon-bar-fill" style="width:${d.memory.percent}%"></div></div></div><div class="sysmon-card"><div class="sysmon-label">Disk</div><div class="sysmon-val">${d.disk.percent.toFixed(0)}%</div><div class="sysmon-sub">${formatBytes(d.disk.free)} free</div></div><div class="sysmon-card"><div class="sysmon-label">Network</div><div class="sysmon-val" style="font-size:15px">‚Üë${formatSpeed(d.network.sent_speed)}</div><div class="sysmon-sub">‚Üì${formatSpeed(d.network.recv_speed)}</div></div>`; document.getElementById('procList').innerHTML = d.top_processes.map(p => `<div class="process-item"><span class="process-name">${p.name}</span><span class="process-val">${(p.cpu_percent||0).toFixed(0)}%</span><span class="process-val">${(p.memory_percent||0).toFixed(0)}%</span></div>`).join(''); } document.getElementById('wCpu').textContent = d.cpu.percent.toFixed(0) + '%'; document.getElementById('wCpuBar').style.width = d.cpu.percent + '%'; document.getElementById('wRam').textContent = d.memory.percent.toFixed(0) + '%'; document.getElementById('wRamSub').textContent = `${formatBytes(d.memory.used)} / ${formatBytes(d.memory.total)}`; document.getElementById('wRamBar').style.width = d.memory.percent + '%'; document.getElementById('wNetUp').textContent = formatSpeed(d.network.sent_speed); document.getElementById('wNetDown').textContent = formatSpeed(d.network.recv_speed); if (d.gpu) { document.getElementById('wGpuWidget').style.display = ''; document.getElementById('wGpu').textContent = d.gpu.load.toFixed(0) + '%'; document.getElementById('wGpuSub').textContent = d.gpu.name; } S.cpuHistory.push(d.cpu.percent); if (S.cpuHistory.length > 20) S.cpuHistory.shift(); document.getElementById('wCpuGraph').innerHTML = S.cpuHistory.map(v => `<div class="widget-graph-bar" style="height:${v}%"></div>`).join(''); } catch {} }
    
    function edNew() { S.session.editorFile = null; document.getElementById('edName').textContent = 'Untitled'; document.getElementById('edContent').value = ''; }
    function edOpen() { const i = document.createElement('input'); i.type = 'file'; i.onchange = async () => { if (!i.files.length) return; const f = i.files[0]; S.session.editorFile = f.name; document.getElementById('edName').textContent = f.name; document.getElementById('edContent').value = await f.text(); }; i.click(); }
    async function openInEditor(path, name) { if (!S.panels.code_editor) createPanel('code_editor'); else focusPanel('code_editor'); try { const res = await fetch('http://127.0.0.1:5011/open', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path }) }); const data = await res.json(); if (data.content !== undefined) { S.session.editorFile = path; document.getElementById('edName').textContent = name; document.getElementById('edContent').value = data.content; } } catch {} }
    async function edSave() { const content = document.getElementById('edContent').value; if (!S.session.editorFile) { S.session.editorFile = prompt('Filename:'); if (!S.session.editorFile) return; document.getElementById('edName').textContent = S.session.editorFile; } try { await fetch('http://127.0.0.1:5011/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: S.session.editorFile, content }) }); setStatus('Saved'); playSound('success'); } catch { setStatus('Error'); playSound('error'); } }
    
    function renderSheet() { const c = document.getElementById('sheetTable'); if (!c) return; c.innerHTML = `<table class="sheet-table"><thead><tr><th>#</th>${S.session.spreadsheet.headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${S.session.spreadsheet.rows.map((r,ri)=>`<tr><td style="color:var(--text-3)">${ri+1}</td>${r.map((c,ci)=>`<td><input value="${c}" onchange="sheetCell(${ri},${ci},this.value)"></td>`).join('')}</tr>`).join('')}</tbody></table>`; }
    function sheetCell(r,c,v) { S.session.spreadsheet.rows[r][c] = v; }
    function sheetNew() { S.session.spreadsheet = { headers: ['A','B','C','D','E'], rows: Array(10).fill(null).map(()=>Array(5).fill('')) }; renderSheet(); }
    function sheetAddRow() { S.session.spreadsheet.rows.push(Array(S.session.spreadsheet.headers.length).fill('')); renderSheet(); }
    function sheetAddCol() { S.session.spreadsheet.headers.push(String.fromCharCode(65+S.session.spreadsheet.headers.length)); S.session.spreadsheet.rows.forEach(r=>r.push('')); renderSheet(); }
    function sheetLoad() { document.getElementById('sheetFile').click(); }
    function loadCSV(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { const lines = ev.target.result.split('\n').filter(l=>l.trim()); S.session.spreadsheet.headers = lines[0].split(',').map(h=>h.trim()); S.session.spreadsheet.rows = lines.slice(1).map(l=>l.split(',').map(c=>c.trim())); renderSheet(); setStatus(`Loaded ${S.session.spreadsheet.rows.length} rows`); playSound('success'); }; r.readAsText(f); }
    
    async function refreshStatus() { const status = await aether.getToolStatus(); S.tools = status; let online = 0; Object.values(status).forEach(info => { if (info.running) online++; }); document.getElementById('wTools').textContent = online; renderSidebar(); }
    
    // ===== AUTO-UPDATE SYSTEM =====
    let pendingUpdates = null;
    
    async function checkUpdates() {
        const overlay = document.getElementById('updateOverlay');
        const content = document.getElementById('updateContent');
        const actions = document.getElementById('updateActions');
        
        overlay.classList.add('active');
        content.innerHTML = '<div class="update-checking">Checking for updates...</div>';
        actions.innerHTML = '';
        playSound('click');
        
        try {
            const result = await aether.checkForUpdates();
            
            if (result.error) {
                content.innerHTML = `
                    <div class="update-checking">
                        <div style="margin-bottom:12px">‚ö†Ô∏è</div>
                        <div>Could not check for updates</div>
                        <div style="font-size:12px;margin-top:8px;color:var(--text-3)">${result.error}</div>
                        <div style="font-size:11px;margin-top:12px;color:var(--text-3)">Current version: ${result.currentVersion || '2.2.0'}</div>
                    </div>
                `;
                actions.innerHTML = '<button class="btn" onclick="closeUpdateModal()">Close</button>';
                return;
            }
            
            if (!result.available) {
                content.innerHTML = `
                    <div class="update-success">
                        <div class="update-success-icon">‚úì</div>
                        <div class="update-success-text">You're up to date!</div>
                        <div class="update-success-sub">Version ${result.currentVersion}</div>
                    </div>
                `;
                actions.innerHTML = '<button class="btn" onclick="closeUpdateModal()">Close</button>';
                playSound('success');
                return;
            }
            
            // Update available
            content.innerHTML = `
                <div class="update-version">
                    <div>
                        <div class="update-version-label">Current Version</div>
                        <div class="update-version-number">${result.currentVersion}</div>
                    </div>
                    <div style="font-size:24px;color:var(--text-3)">‚Üí</div>
                    <div>
                        <div class="update-version-label">New Version</div>
                        <div class="update-version-number update-version-new">${result.latestVersion}</div>
                    </div>
                </div>
                <div class="update-release-name">${result.releaseName || ''}</div>
                ${result.releaseNotes ? `<div class="update-notes">${result.releaseNotes.slice(0, 500)}${result.releaseNotes.length > 500 ? '...' : ''}</div>` : ''}
            `;
            
            pendingUpdates = result;
            
            actions.innerHTML = `
                <button class="btn" onclick="closeUpdateModal()">Later</button>
                <button class="btn primary" onclick="downloadUpdate()">Download Update</button>
            `;
            
            playSound('open');
            
        } catch (err) {
            content.innerHTML = `<div class="update-checking">Error: ${err.message}</div>`;
            actions.innerHTML = '<button class="btn" onclick="closeUpdateModal()">Close</button>';
            playSound('error');
        }
    }
    
    async function downloadUpdate() {
        if (!pendingUpdates?.downloadUrl) {
            setStatus('No download URL available');
            return;
        }
        
        const content = document.getElementById('updateContent');
        const actions = document.getElementById('updateActions');
        
        content.innerHTML = `
            <div class="update-progress">
                <div class="update-progress-text">Opening download page...</div>
            </div>
        `;
        actions.innerHTML = '';
        
        try {
            await aether.downloadUpdate(pendingUpdates.downloadUrl);
            
            content.innerHTML = `
                <div class="update-success">
                    <div class="update-success-icon">‚Üì</div>
                    <div class="update-success-text">Download started!</div>
                    <div class="update-success-sub">After downloading, run the installer to update</div>
                </div>
            `;
            actions.innerHTML = '<button class="btn" onclick="closeUpdateModal()">Close</button>';
            playSound('success');
        } catch (e) {
            content.innerHTML = `<div class="update-checking">Failed to open download: ${e.message}</div>`;
            actions.innerHTML = '<button class="btn" onclick="closeUpdateModal()">Close</button>';
            playSound('error');
        }
    }
    
    function closeUpdateModal() {
        document.getElementById('updateOverlay').classList.remove('active');
        pendingUpdates = null;
        playSound('close');
    }
    
    async function restartApp() {
        await aether.restartApp();
    }
    
    // ===== VIRAL STUDIO FUNCTIONS =====
    let vsSelectedClips = [];
    
    function vsTab(tab) {
        document.querySelectorAll('.viral-panel').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.viral-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('vs' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.display = 'block';
        event.target.classList.add('active');
        
        if (tab === 'render') vsUpdateSummary();
        playSound('click');
    }
    
    function vsLoadNiche() {
        const niche = document.getElementById('vsNiche').value;
        const keywords = {
            motivation: 'success, business, entrepreneur',
            scary: 'dark, forest, night, creepy',
            facts: 'science, nature, space',
            storytime: 'people, city, conversation',
            finance: 'money, business, investment',
            custom: ''
        };
        document.getElementById('vsFootageQuery').value = keywords[niche] || '';
    }
    
    async function vsGenScript() {
        const topic = document.getElementById('vsTopic').value.trim();
        const niche = document.getElementById('vsNiche').value;
        if (!topic) { alert('Please enter a topic'); return; }
        
        document.getElementById('vsScriptText').value = 'Generating script...';
        setStatus('Generating script...');
        playSound('click');
        
        try {
            const res = await fetch('http://127.0.0.1:5020/generate/script', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic, niche })
            });
            const data = await res.json();
            
            if (data.script) {
                document.getElementById('vsScriptText').value = data.script;
                document.getElementById('vsWordCount').textContent = data.word_count || 0;
                document.getElementById('vsDuration').textContent = Math.round(data.estimated_duration || 0);
                if (data.suggested_keywords) {
                    document.getElementById('vsFootageQuery').value = data.suggested_keywords.slice(0, 3).join(', ');
                }
                setStatus('Script generated');
                playSound('success');
            } else {
                document.getElementById('vsScriptText').value = '';
                setStatus('Failed to generate script');
                playSound('error');
            }
        } catch (e) {
            document.getElementById('vsScriptText').value = 'Error: ' + e.message;
            setStatus('Error');
            playSound('error');
        }
    }
    
    async function vsSearchFootage() {
        const query = document.getElementById('vsFootageQuery').value.trim();
        if (!query) return;
        
        const grid = document.getElementById('vsFootageGrid');
        grid.innerHTML = '<div style="color:var(--text-3);text-align:center;padding:40px">Searching...</div>';
        setStatus('Searching footage...');
        playSound('click');
        
        try {
            const res = await fetch('http://127.0.0.1:5020/search/footage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, source: 'all', per_page: 12 })
            });
            const data = await res.json();
            
            const allVideos = [...(data.pixabay || []), ...(data.pexels || [])];
            
            if (allVideos.length === 0) {
                grid.innerHTML = '<div style="color:var(--text-3);text-align:center;padding:40px">No footage found. Try different keywords or add API keys.</div>';
                return;
            }
            
            grid.innerHTML = allVideos.map(v => `
                <div class="viral-footage-item ${vsSelectedClips.find(c => c.id === v.id) ? 'selected' : ''}" 
                     onclick="vsToggleClip(${JSON.stringify(v).replace(/"/g, '&quot;')})">
                    <img src="${v.thumbnail || v.preview}" alt="">
                    <span class="duration">${v.duration}s</span>
                </div>
            `).join('');
            
            setStatus(`Found ${allVideos.length} clips`);
            playSound('success');
        } catch (e) {
            grid.innerHTML = '<div style="color:var(--text-3);text-align:center;padding:40px">Error: ' + e.message + '</div>';
            playSound('error');
        }
    }
    
    function vsToggleClip(clip) {
        const idx = vsSelectedClips.findIndex(c => c.id === clip.id);
        if (idx >= 0) {
            vsSelectedClips.splice(idx, 1);
        } else {
            vsSelectedClips.push(clip);
        }
        vsRenderSelectedClips();
        playSound('click');
    }
    
    function vsRemoveClip(id) {
        vsSelectedClips = vsSelectedClips.filter(c => c.id !== id);
        vsRenderSelectedClips();
        playSound('click');
    }
    
    function vsRenderSelectedClips() {
        const container = document.getElementById('vsSelectedClips');
        document.getElementById('vsClipCount').textContent = vsSelectedClips.length;
        
        if (vsSelectedClips.length === 0) {
            container.innerHTML = '<div style="color:var(--text-3);font-size:12px">Click footage above to select</div>';
            return;
        }
        
        container.innerHTML = vsSelectedClips.map(c => `
            <div class="viral-selected-clip">
                <img src="${c.thumbnail || c.preview}" alt="">
                <div class="remove" onclick="vsRemoveClip(${c.id})">√ó</div>
            </div>
        `).join('');
        
        // Update footage grid selection state
        document.querySelectorAll('.viral-footage-item').forEach(item => {
            const isSelected = vsSelectedClips.some(c => item.querySelector('img').src.includes(c.thumbnail || c.preview));
            item.classList.toggle('selected', isSelected);
        });
    }
    
    async function vsPreviewVoice() {
        const voice = document.getElementById('vsVoiceSelect').value;
        setStatus('Generating preview...');
        playSound('click');
        
        try {
            const res = await fetch('http://127.0.0.1:5020/preview/voice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ voice })
            });
            const data = await res.json();
            
            if (data.audio) {
                document.getElementById('vsVoicePreview').innerHTML = 
                    `<audio controls src="data:audio/mp3;base64,${data.audio}"></audio>`;
                setStatus('Preview ready');
                playSound('success');
            }
        } catch (e) {
            setStatus('Preview failed');
            playSound('error');
        }
    }
    
    function vsUpdateSummary() {
        const script = document.getElementById('vsScriptText').value;
        const voice = document.getElementById('vsVoiceSelect');
        const style = document.getElementById('vsCaptionStyle');
        
        document.getElementById('vsSummaryWords').textContent = script.split(/\s+/).filter(w => w).length;
        document.getElementById('vsSummaryClips').textContent = vsSelectedClips.length;
        document.getElementById('vsSummaryVoice').textContent = voice.options[voice.selectedIndex].text.split('(')[0].trim();
        document.getElementById('vsSummaryStyle').textContent = style.options[style.selectedIndex].text;
    }
    
    async function vsRenderVideo() {
        const script = document.getElementById('vsScriptText').value.trim();
        const voice = document.getElementById('vsVoiceSelect').value;
        const captionStyle = document.getElementById('vsCaptionStyle').value;
        const preview = document.getElementById('vsVideoPreview');
        
        if (!script) { alert('Please write or generate a script first'); return; }
        if (vsSelectedClips.length === 0) { alert('Please select some footage clips'); return; }
        
        preview.innerHTML = '<span class="gen-placeholder gen-loading">Generating video... This may take a few minutes.</span>';
        setStatus('Rendering video...');
        playSound('click');
        
        try {
            const clipUrls = vsSelectedClips.map(c => c.download);
            
            const res = await fetch('http://127.0.0.1:5020/generate/video', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    script,
                    clips: clipUrls,
                    voice,
                    caption_style: captionStyle
                })
            });
            const data = await res.json();
            
            if (data.video) {
                preview.innerHTML = `
                    <video controls style="max-width:100%;max-height:400px;border-radius:var(--radius-sm)">
                        <source src="data:video/mp4;base64,${data.video}" type="video/mp4">
                    </video>
                    <div style="margin-top:10px">
                        <a href="data:video/mp4;base64,${data.video}" download="viral_video.mp4" class="btn primary">Download Video</a>
                    </div>
                `;
                setStatus('Video ready!');
                playSound('success');
            } else {
                preview.innerHTML = `<span class="gen-placeholder">Error: ${data.error || 'Unknown error'}</span>`;
                setStatus('Render failed');
                playSound('error');
            }
        } catch (e) {
            preview.innerHTML = `<span class="gen-placeholder">Error: ${e.message}</span>`;
            setStatus('Error');
            playSound('error');
        }
    }
    
    async function vsSaveApiKeys() {
        const pixabay = document.getElementById('vsPixabayKey').value.trim();
        const pexels = document.getElementById('vsPexelsKey').value.trim();
        
        try {
            await fetch('http://127.0.0.1:5020/config/api-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pixabay, pexels })
            });
            setStatus('API keys saved');
            playSound('success');
        } catch (e) {
            setStatus('Failed to save keys');
            playSound('error');
        }
    }
    
    // Update word count on script change
    document.addEventListener('input', (e) => {
        if (e.target.id === 'vsScriptText') {
            const words = e.target.value.split(/\s+/).filter(w => w).length;
            const el = document.getElementById('vsWordCount');
            if (el) el.textContent = words;
            const dur = document.getElementById('vsDuration');
            if (dur) dur.textContent = Math.round(words / 2.5);
        }
    });

    // Animated dot grid background
    function initDotGrid() {
        const canvas = document.getElementById('dotGrid');
        const ctx = canvas.getContext('2d');
        let dots = [];
        let mouse = { x: -1000, y: -1000 };
        const spacing = 30;
        const dotRadius = 1;
        const maxInfluence = 100;
        
        function resize() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
            createDots();
        }
        
        function createDots() {
            dots = [];
            const cols = Math.ceil(canvas.width / spacing) + 1;
            const rows = Math.ceil(canvas.height / spacing) + 1;
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    dots.push({
                        x: i * spacing,
                        y: j * spacing,
                        baseX: i * spacing,
                        baseY: j * spacing
                    });
                }
            }
        }
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (const dot of dots) {
                const dx = mouse.x - dot.baseX;
                const dy = mouse.y - dot.baseY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < maxInfluence) {
                    const force = (1 - dist / maxInfluence) * 8;
                    dot.x = dot.baseX + (dx / dist) * force;
                    dot.y = dot.baseY + (dy / dist) * force;
                } else {
                    dot.x += (dot.baseX - dot.x) * 0.1;
                    dot.y += (dot.baseY - dot.y) * 0.1;
                }
                
                const brightness = dist < maxInfluence ? 0.4 + (1 - dist / maxInfluence) * 0.4 : 0.2;
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, dotRadius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${brightness})`;
                ctx.fill();
            }
            
            requestAnimationFrame(draw);
        }
        
        canvas.parentElement.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });
        
        canvas.parentElement.addEventListener('mouseleave', () => {
            mouse.x = -1000;
            mouse.y = -1000;
        });
        
        window.addEventListener('resize', resize);
        resize();
        draw();
    }
    
    async function init() { 
        await loadSession(); 
        await loadPlugins();
        initDotGrid(); 
        const layout = loadLayout(); 
        const toOpen = Object.keys(layout).length ? Object.keys(layout) : Object.keys(DEFAULT_LAYOUT); 
        toOpen.forEach(id => {
            if (TOOLS[id]) {
                createPanel(id);
            } else if (PLUGINS[id]) {
                createPluginPanel(id, PLUGINS[id]);
            }
        }); 
        renderSidebar(); 
        setInterval(() => { 
            document.getElementById('wUptime').textContent = formatTime(Date.now() - S.startTime); 
            document.getElementById('statusTime').textContent = new Date().toLocaleTimeString(); 
        }, 1000); 
        setInterval(refreshStatus, 5000); 
        setInterval(updateSysmon, 2000); 
        setInterval(saveSession, 30000); 
        aether.onToolReady(() => refreshStatus()); 
        aether.onToolStopped(() => refreshStatus()); 
        
        // Listen for plugin download progress
        aether.onPluginDownloadProgress((data) => {
            setStatus(`Plugin ${data.plugin}: ${data.status} ${data.percent || 0}%`);
            if (data.status === 'complete') {
                loadPlugins().then(() => {
                    refreshStatus();
                    if (S.launcherTab === 'plugins') renderPluginsTab();
                });
            }
        });
        
        refreshStatus(); 
        setTimeout(() => playSound('success'), 500); 
    }
    
    init();
    </script>
</body>
</html>
